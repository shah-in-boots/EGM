---
title: "Understanding Annotations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Understanding WFDB Annotations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(EGM)
```

# Overview

WFDB annotation files use a compact coding scheme to describe events that are
associated with a waveform. While the [annotation_table()] object exposes the
raw symbol, subtype, channel, and number columns, these codes are easier to
interpret once they are paired with the standard WFDB nomenclature. The helper
functions introduced in this vignette summarise the official label definitions
and make it straightforward to apply them to annotations that have been read in
with [read_annotation()].

# Standard WFDB labels

The [wfdb_annotation_labels()] helper returns the canonical mapping between the
label store integer, the display symbol, a mnemonic, and the long description
provided in the WFDB Applications Guide. The `is_qrs` column flags the symbols
that correspond to QRS-complex detections.

```{r}
wfdb_annotation_labels()
```

The result can be filtered with either annotation symbols or label store values.
For example, this subset highlights common beat labels:

```{r}
wfdb_annotation_labels(symbol = c("N", "V", "L", "R"))
```

# Working with ECGPUWAVE annotations

The package ships with a collection of ECGPUWAVE annotations that can be used as
a self-contained example. The code below copies the sample record to a temporary
folder, reads the accompanying header, and loads the annotation file.

```{r}
tmp_dir <- tempfile(pattern = "ecgpuwave-")
dir.create(tmp_dir)
files <- c("muse-sinus.dat", "muse-sinus.hea", "muse-sinus.ecgpuwave")
file.copy(
  from = system.file("extdata", files, package = "EGM"),
  to = tmp_dir
)

header <- read_header("muse-sinus", record_dir = tmp_dir)
ann <- read_annotation(
  record = "muse-sinus",
  annotator = "ecgpuwave",
  record_dir = tmp_dir,
  header = header
)
head(ann)
```

The annotation `type` column records WFDB symbols such as `p`, `t`, `(`, and `)`
that identify the peaks, onsets, and offsets of the delineated waveforms. The
[wfdb_annotation_decode()] helper joins the standard nomenclature onto the
annotation table so that the meaning of each symbol is explicit.

```{r}
decoded <- wfdb_annotation_decode(ann)
head(decoded[, c("time", "sample", "type", "mnemonic", "description", "number")])
```

For ECGPUWAVE files the `number` column acts as a modifier that distinguishes
between P waves (`0`), QRS complexes (`1`), and T waves (`2`). Combined with the
standard symbol descriptions this makes it easy to identify the start, peak, and
end of each waveform.

```{r}
unique(decoded[decoded$type %in% c("p", "(", ")"), c("type", "mnemonic", "description", "number")])
```

These helpers can be applied to any WFDB-compatible annotation file, enabling
quick inspection of the coded events before further analysis or visualisation.
